<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventário Visão (Debug Mode)</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos Essenciais */
        body { font-family: 'Poppins', sans-serif; background: #eef2ff; color: #333; margin: 0; padding: 0; }
        
        /* DIAGNÓSTICO (Para sabermos o erro) */
        #debug-panel {
            background: #000; color: #0f0; padding: 10px; font-family: monospace; 
            border-bottom: 2px solid #0f0; max-height: 150px; overflow-y: auto; font-size: 12px;
        }

        /* LOGIN */
        #login-screen {
            position: fixed; inset: 0; z-index: 1000; display: flex; justify-content: center; align-items: center;
            background: linear-gradient(135deg, #4338ca 0%, #312e81 100%);
        }
        .login-card {
            background: rgba(255,255,255,0.95); padding: 40px; border-radius: 20px; width: 350px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box;}
        .btn { width: 100%; padding: 12px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;}
        .btn:hover { background: #4338ca; }

        /* APP */
        #app-screen { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
        header { background: white; padding: 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .avatar { width: 40px; height: 40px; background: #e0e7ff; color: #4f46e5; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; }

        .tree-item { background: #f9fafb; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .progress-bg { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin: 5px 0; }
        .progress-fill { height: 100%; transition: width 0.5s; background: #4f46e5; }
        .stats { display: flex; justify-content: space-between; font-size: 0.8rem; color: #666; margin-top: 5px; }

        /* Botão Novo Analista */
        .new-analyst { border: 2px dashed #ccc; display: flex; justify-content: center; align-items: center; flex-direction: column; color: #888; cursor: pointer; min-height: 200px; border-radius: 15px; }
        .new-analyst:hover { border-color: #4f46e5; color: #4f46e5; background: white; }

        /* Icon Btns */
        .icon-btn { cursor: pointer; margin-left: 5px; color: #666; }
        .icon-btn:hover { color: red; }

        /* Loading Overlay */
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <div id="debug-panel">
        <strong>STATUS DO SISTEMA:</strong><br>
        <span id="logs">Inicializando...</span>
    </div>

    <div id="loading"><i class="fas fa-spinner fa-spin fa-3x" style="color: #4f46e5;"></i></div>

    <div id="login-screen">
        <div class="login-card">
            <h2>Inventário Visão</h2>
            <p>Admin Login</p>
            <input type="text" id="userIn" placeholder="Seu nome (Ex: Leo)">
            <button class="btn" onclick="logar()">Entrar</button>
            <p style="font-size: 12px; color: #ccc; margin-top: 10px;">Se não entrar, verifique o painel preto acima.</p>
        </div>
    </div>

    <div id="app-screen">
        <header>
            <h1>Dashboard</h1>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="welcome"></span>
                <button onclick="sair()" style="background: #fee2e2; border:none; padding: 5px 10px; border-radius: 5px; color: red; cursor:pointer;">Sair</button>
            </div>
        </header>

        <div id="grid" class="grid">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, arrayUnion } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // LOG DE DEBUG VISUAL
        function log(msg, error = false) {
            const painel = document.getElementById('logs');
            const color = error ? 'red' : '#0f0';
            painel.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            console.log(msg);
        }

        log("Carregando configurações do Firebase...");

        // SUAS CHAVES (Já inseridas)
        const firebaseConfig = {
            apiKey: "AIzaSyC3vK2aGsf7Omxks1kWLmkqVmoyeaQwWtI",
            authDomain: "inventario-visao-arvore.firebaseapp.com",
            projectId: "inventario-visao-arvore",
            storageBucket: "inventario-visao-arvore.firebasestorage.app",
            messagingSenderId: "835161543929",
            appId: "1:835161543929:web:baa01989f20cac5d3f3e28"
        };

        let db;
        let localData = [];

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            log("Firebase SDK Inicializado com Sucesso!");
        } catch (e) {
            log("ERRO CRÍTICO AO INICIAR FIREBASE: " + e.message, true);
        }

        // Funções Globais
        window.logar = function() {
            const u = document.getElementById('userIn').value;
            if(!u) return alert("Digite um nome");
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            document.getElementById('welcome').innerText = u;
            
            iniciarEscuta();
        }

        window.sair = () => location.reload();

        // 1. ESCUTA DO BANCO DE DADOS
        function iniciarEscuta() {
            log("Tentando conectar ao Firestore...");
            const grid = document.getElementById('grid');

            try {
                onSnapshot(collection(db, "analistas"), (snapshot) => {
                    log("Conexão estabelecida! Recebendo dados...");
                    grid.innerHTML = '';
                    localData = [];

                    if(snapshot.empty) {
                        log("Conectado, mas a coleção 'analistas' está vazia.");
                        grid.innerHTML = '<p style="grid-column:1/-1; text-align:center;">Nenhum analista. Adicione um abaixo.</p>';
                    }

                    snapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        const user = { id: docSnap.id, ...data };
                        localData.push(user);
                        renderCard(user, grid);
                    });

                    // Botão Adicionar sempre no final
                    grid.innerHTML += `
                        <div class="new-analyst" onclick="addUser()">
                            <i class="fas fa-plus fa-3x" style="margin-bottom:10px;"></i>
                            NOVO ANALISTA
                        </div>
                    `;

                }, (error) => {
                    // AQUI É ONDE PEGAMOS O ERRO DE TELA BRANCA
                    if(error.code === 'permission-denied') {
                        log("ERRO: PERMISSÃO NEGADA. Vá no Firebase Console > Rules e altere para 'true'.", true);
                        alert("ERRO DE PERMISSÃO!\n\nO banco de dados está bloqueado.\nVocê precisa ir no Console do Firebase > Firestore > Regras e mudar 'false' para 'true'.");
                    } else if (error.code === 'not-found') {
                        log("ERRO: BANCO NÃO ENCONTRADO. Crie o Firestore no Console.", true);
                    } else {
                        log("ERRO DESCONHECIDO: " + error.message, true);
                    }
                });
            } catch (e) {
                log("ERRO NO ONSNAPSHOT: " + e.message, true);
            }
        }

        // 2. RENDERIZAÇÃO
        function renderCard(user, container) {
            let treesHtml = '';
            if(user.arvores && user.arvores.length > 0) {
                user.arvores.forEach(tree => {
                    let color = tree.progresso >= 100 ? '#10b981' : '#f59e0b';
                    treesHtml += `
                        <div class="tree-item">
                            <div style="display:flex; justify-content:space-between; font-weight:600;">
                                <span>${tree.nome}</span>
                                <span style="color:${color}">${tree.progresso}%</span>
                            </div>
                            <div class="progress-bg"><div class="progress-fill" style="width:${tree.progresso}%; background:${color}"></div></div>
                            <div class="stats">
                                <span>Total: ${tree.total||0}</span>
                                <span style="cursor:pointer; color:red;" onclick="delTree('${user.id}', '${tree.id}')"><i class="fas fa-trash"></i></span>
                                <label style="cursor:pointer; color:blue;">
                                    <i class="fas fa-upload"></i>
                                    <input type="file" hidden onchange="uploadXls(this, '${user.id}', '${tree.id}')">
                                </label>
                            </div>
                        </div>
                    `;
                });
            } else {
                treesHtml = '<small style="color:#999">Sem árvores.</small>';
            }

            container.innerHTML += `
                <div class="card">
                    <div class="card-header">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="avatar">${user.nome[0].toUpperCase()}</div>
                            <strong>${user.nome}</strong>
                        </div>
                        <i class="fas fa-times icon-btn" onclick="delUser('${user.id}')"></i>
                    </div>
                    <div>${treesHtml}</div>
                    <button style="width:100%; margin-top:10px; padding:8px; border:1px solid #eee; background:white; cursor:pointer;" onclick="addTree('${user.id}')">+ Árvore</button>
                </div>
            `;
        }

        // 3. FUNÇÕES (Globais para HTML acessar)
        window.addUser = async () => {
            const nome = prompt("Nome:");
            if(nome) await addDoc(collection(db, "analistas"), { nome, arvores: [] });
        }

        window.delUser = async (id) => {
            if(confirm("Apagar?")) await deleteDoc(doc(db, "analistas", id));
        }

        window.addTree = async (uid) => {
            const nome = prompt("Nome da Árvore:");
            if(nome) {
                await updateDoc(doc(db, "analistas", uid), {
                    arvores: arrayUnion({ id: 't'+Date.now(), nome, progresso:0, total:0, pendentes:0 })
                });
            }
        }

        window.delTree = async (uid, tid) => {
            if(confirm("Apagar árvore?")) {
                const u = localData.find(x => x.id === uid);
                const novas = u.arvores.filter(x => x.id !== tid);
                await updateDoc(doc(db, "analistas", uid), { arvores: novas });
            }
        }

        window.uploadXls = function(input, uid, tid) {
            const file = input.files[0];
            if(!file) return;
            
            document.getElementById('loading').style.display = 'flex';
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, {type:'array'});
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    let ok=0, nok=0;
                    const cols = ["SECAO", "GRUPO", "SUBGRUPO"];
                    
                    json.forEach(row => {
                        const hasVal = cols.some(c => row[c] && String(row[c]).trim().length > 0);
                        hasVal ? ok++ : nok++;
                    });

                    const total = ok+nok;
                    const prog = total===0 ? 0 : ((ok/total)*100).toFixed(1);

                    const u = localData.find(x => x.id === uid);
                    const novas = u.arvores.map(t => t.id === tid ? {...t, progresso:prog, total, pendentes:nok} : t);
                    
                    await updateDoc(doc(db, "analistas", uid), { arvores: novas });
                    alert("Atualizado!");
                } catch(err) {
                    alert("Erro: " + err.message);
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        }

    </script>
</body>
</html>

