<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise de Progresso - Classifica√ß√£o</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; background: #f0f2f5; color: #333; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { margin-top: 0; color: #1a73e8; }
        .upload-area { border: 2px dashed #ccc; padding: 30px; text-align: center; border-radius: 8px; margin-bottom: 20px; transition: 0.3s; }
        .upload-area:hover { border-color: #1a73e8; background: #f8fbff; }
        
        button { background-color: #1a73e8; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: #1557b0; }
        
        .result-box { margin-top: 25px; padding: 20px; background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 8px; display: none; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 14px; }
        
        /* Barra de progresso customizada */
        progress { width: 100%; height: 25px; border-radius: 5px; margin-top: 10px; }
        progress::-webkit-progress-bar { background-color: #eee; border-radius: 5px; }
        progress::-webkit-progress-value { background-color: #4caf50; border-radius: 5px; transition: width 0.5s ease; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìä Auditoria de Classifica√ß√£o</h2>
    <p>Selecione a planilha com as colunas: <strong>SECAO, GRUPO, SUBGRUPO</strong>.</p>
    
    <div class="upload-area">
        <input type="file" id="inputExcel" accept=".xlsx, .xls" />
    </div>
    
    <div style="text-align: right;">
        <button onclick="executarAnalise()">Processar Arquivo</button>
    </div>

    <div id="resultArea" class="result-box">
        <h3>Resultado da An√°lise:</h3>
        <div id="humanReadable"></div>
        <hr>
        <small>Sa√≠da JSON (para o Firebase):</small>
        <pre id="jsonOutput">Processando...</pre>
    </div>
</div>

<script>
/**
 * L√≥gica de Neg√≥cio: Analisador de Classifica√ß√£o
 */
class ProductAnalyzer {
    constructor(targetColumns) {
        // Colunas que definem se o produto est√° classificado (SEM ACENTO conforme sua imagem)
        this.targetColumns = targetColumns; 
    }

    async processFile(fileInput) {
        if (!fileInput.files || fileInput.files.length === 0) {
            throw new Error("Por favor, selecione um arquivo Excel primeiro.");
        }

        const file = fileInput.files[0];
        const data = await file.arrayBuffer();
        
        // Leitura do arquivo
        const workbook = XLSX.read(data);
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        // Converte para JSON. 
        // 'defval: ""' garante que c√©lulas vazias n√£o venham como 'undefined'
        const rawData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        if (rawData.length === 0) {
            throw new Error("A planilha parece estar vazia.");
        }

        return this.calculateStats(rawData);
    }

    calculateStats(productList) {
        let classifiedCount = 0;
        let pendingCount = 0;

        productList.forEach(product => {
            // Verifica se o produto tem ao menos UMA das colunas preenchidas
            const isClassified = this.targetColumns.some(col => {
                const value = product[col];
                // Checa se o valor existe e n√£o √© s√≥ espa√ßo em branco
                return value !== undefined && value !== "" && String(value).trim() !== "";
            });

            if (isClassified) {
                classifiedCount++;
            } else {
                pendingCount++;
            }
        });

        const total = classifiedCount + pendingCount;
        const progress = total === 0 ? 0 : ((classifiedCount / total) * 100).toFixed(1);

        return {
            total_produtos: total,
            total_classificados: classifiedCount,
            total_pendentes: pendingCount,
            percentual_conclusao: parseFloat(progress),
            data_analise: new Date().toISOString() // Adicionei data para registro
        };
    }
}

// --- CONFIGURA√á√ÉO ---
// Aqui est√£o os nomes exatos extra√≠dos da sua imagem
const CONFIG_COLUNAS = ["SECAO", "GRUPO", "SUBGRUPO"]; 

const analyzer = new ProductAnalyzer(CONFIG_COLUNAS);

async function executarAnalise() {
    const fileInput = document.getElementById('inputExcel');
    const resultArea = document.getElementById('resultArea');
    const jsonOutput = document.getElementById('jsonOutput');
    const humanReadable = document.getElementById('humanReadable');

    try {
        // Executa a classe
        const stats = await analyzer.processFile(fileInput);

        // Atualiza a interface
        resultArea.style.display = 'block';
        
        // Mostra JSON formatado
        jsonOutput.textContent = JSON.stringify(stats, null, 2);
        
        // Mostra visual amig√°vel
        humanReadable.innerHTML = `
            <div style="font-size: 1.2em; margin-bottom: 10px;">
                <strong>Progresso:</strong> ${stats.percentual_conclusao}%
            </div>
            <progress value="${stats.percentual_conclusao}" max="100"></progress>
            <ul style="margin-top: 15px;">
                <li>üì¶ Total de Produtos: <strong>${stats.total_produtos}</strong></li>
                <li>‚úÖ Classificados: <strong>${stats.total_classificados}</strong></li>
                <li>‚ö†Ô∏è Pendentes: <strong>${stats.total_pendentes}</strong></li>
            </ul>
        `;

        console.log("Dados prontos para envio ao Firebase:", stats);

    } catch (error) {
        alert("Erro: " + error.message);
        console.error(error);
    }
}
</script>

</body>
</html>